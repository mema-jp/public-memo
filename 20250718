ã‚‚ã¡ã‚ã‚“ã§ã™ï¼GitLab CI + Claude APIã‚’ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã®æ–¹æ¡ˆã‚’æ—¥æœ¬èªã§èª¬æ˜ã—ã¾ã™ã€‚

## å®Ÿè£…æ–¹æ¡ˆ

**GitLab CI + Claude APIã§ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹æ³•**

```yaml
# .gitlab-ci.yml
stages:
  - code-quality

ai-code-review:
  stage: code-quality
  image: python:3.9
  script:
    - pip install anthropic
    - python ai_code_check.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false
```

## Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# ai_code_check.py
import anthropic
import subprocess
import os

def get_code_diff():
    """ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹"""
    result = subprocess.run(
        ['git', 'diff', 'origin/main...HEAD'],
        capture_output=True, text=True
    )
    return result.stdout

def check_code_quality(diff_content):
    """Claude APIã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹"""
    client = anthropic.Anthropic(
        api_key=os.environ['ANTHROPIC_API_KEY']
    )
    
    message = client.messages.create(
        model="claude-3-sonnet-20240229",
        max_tokens=1000,
        messages=[{
            "role": "user",
            "content": f"""
            ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚é‡ç‚¹çš„ã«ç¢ºèªã™ã‚‹é …ç›®ï¼š
            1. ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¸€è²«æ€§
            2. æ½œåœ¨çš„ãªãƒã‚°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œ
            4. ä¿å®ˆæ€§ã¨å¯èª­æ€§
            5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            
            é‡å¤§ãªå•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€å›ç­”ã®å†’é ­ã«ã€ŒFAIL:ã€ã‚’ä»˜ã‘ã¦ãã ã•ã„
            ã‚³ãƒ¼ãƒ‰å“è³ªãŒè‰¯å¥½ãªå ´åˆã¯ã€å›ç­”ã®å†’é ­ã«ã€ŒPASS:ã€ã‚’ä»˜ã‘ã¦ãã ã•ã„
            
            å…·ä½“çš„ãªå•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆã‚‚å«ã‚ã¦ãã ã•ã„ã€‚
            
            ã‚³ãƒ¼ãƒ‰å¤‰æ›´å†…å®¹ï¼š
            {diff_content}
            """
        }]
    )
    
    response = message.content[0].text
    
    if response.startswith("FAIL:"):
        print(f"âŒ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ:\n{response}")
        return False
    else:
        print(f"âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒåˆæ ¼ã—ã¾ã—ãŸ:\n{response}")
        return True

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("ğŸš€ AIã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...")
    
    # ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’å–å¾—
    diff = get_code_diff()
    if not diff.strip():
        print("ğŸ“ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
        exit(0)
    
    print(f"ğŸ“Š {len(diff.splitlines())} è¡Œã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚")
    
    # ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
    if not check_code_quality(diff):
        print("ğŸ’¥ CIã‚’å¤±æ•—ã•ã›ã¾ã™ã€‚")
        exit(1)
    
    print("ğŸ‰ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")

if __name__ == "__main__":
    main()
```

## ç’°å¢ƒè¨­å®š

**1. GitLabãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š**

- Settings â†’ CI/CD â†’ Variables ã§ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
  - `ANTHROPIC_API_KEY`: Claude APIã‚­ãƒ¼ï¼ˆProtectedå¤‰æ•°ã¨ã—ã¦è¨­å®šï¼‰

**2. ã‚ˆã‚Šè©³ç´°ãªãƒã‚§ãƒƒã‚¯è¨­å®š**

```python
# config.py
CODE_QUALITY_RULES = {
    "max_lines_per_function": 50,
    "max_complexity": 10,
    "required_test_coverage": 80,
    "security_check": True,
    "performance_check": True
}

# ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚ˆã‚Šè©³ç´°ã«è¨­å®š
QUALITY_CHECK_PROMPT = """
ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

ã€ãƒã‚§ãƒƒã‚¯é …ç›®ã€‘
1. ğŸ¯ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ï¼ˆå‘½åè¦å‰‡ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã€ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
2. ğŸ› ãƒã‚°ã®å¯èƒ½æ€§ï¼ˆnullå‚ç…§ã€å¢ƒç•Œå€¤ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
3. ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œï¼ˆSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSãªã©ï¼‰
4. âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆåŠ¹ç‡çš„ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼‰
5. ğŸ”§ ä¿å®ˆæ€§ï¼ˆé–¢æ•°ã®é•·ã•ã€è¤‡é›‘åº¦ã€å†åˆ©ç”¨æ€§ï¼‰
6. ğŸ§ª ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§

ã€åˆ¤å®šåŸºæº–ã€‘
- é‡å¤§ãªå•é¡ŒãŒã‚ã‚‹å ´åˆï¼šFAIL: ã§é–‹å§‹
- è»½å¾®ãªæ”¹å–„ææ¡ˆã®ã¿ï¼šPASS: ã§é–‹å§‹

ã€å‡ºåŠ›å½¢å¼ã€‘
PASS/FAIL: [åˆ¤å®šçµæœ]
å•é¡Œç‚¹ï¼š[å…·ä½“çš„ãªå•é¡Œã¨ãã®ç†ç”±]
æ”¹å–„ææ¡ˆï¼š[æ¨å¥¨ã™ã‚‹ä¿®æ­£æ–¹æ³•]
è©•ä¾¡ï¼š[A-F ã§ã®è©•ä¾¡]
"""
```

## ä½¿ç”¨æ–¹æ³•

1. ä¸Šè¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«é…ç½®
1. GitLabã§APIã‚­ãƒ¼ã‚’è¨­å®š
1. Merge Requestã‚’ä½œæˆã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¾ã™

ã“ã‚Œã§Merge Requestæ™‚ã«è‡ªå‹•çš„ã«AIãŒã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å•é¡ŒãŒã‚ã‚Œã°CIãŒå¤±æ•—ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä½•ã‹ã”è³ªå•ã‚„è¿½åŠ ã®æ©Ÿèƒ½ãŒå¿…è¦ã§ã—ãŸã‚‰ã€ãŠèã‹ã›ãã ã•ã„ï¼â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹





ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æ—¥æœ¬èªç‰ˆã®æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨CIå®Ÿè¡Œåˆ¶å¾¡ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–

**æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¾‹**

```python
def get_optimized_prompt(diff_content, file_types, commit_message=""):
    prompt = f"""
ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«ã¤ã„ã¦åŒ…æ‹¬çš„ãªå“è³ªè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´æƒ…å ±ã€‘
- ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {commit_message}
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: {', '.join(file_types)}
- å¤‰æ›´è¦æ¨¡: {len(diff_content.splitlines())} è¡Œ

ã€è©•ä¾¡åŸºæº–ã€‘
1. ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ª (é…ç‚¹30%)
   - å‘½åè¦å‰‡ã€ã‚³ãƒ¼ãƒ‰æ§‹é€ ã€ã‚³ãƒ¡ãƒ³ãƒˆã®è³ª
   - é–¢æ•°ã®è¤‡é›‘ã•ã€ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡

2. ğŸ› æ½œåœ¨çš„ãªå•é¡Œ (é…ç‚¹25%)
   - ãƒã‚°ãƒªã‚¹ã‚¯ã€å¢ƒç•Œæ¡ä»¶ã®å‡¦ç†
   - ä¾‹å¤–å‡¦ç†ã€ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯

3. ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (é…ç‚¹20%)
   - å…¥åŠ›æ¤œè¨¼ã€æ¨©é™åˆ¶å¾¡
   - æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©

4. âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ (é…ç‚¹15%)
   - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŠ¹ç‡æ€§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ä¸¦è¡Œå®‰å…¨æ€§

5. ğŸ§ª ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ (é…ç‚¹10%)
   - ãƒ†ã‚¹ãƒˆã®æ›¸ãã‚„ã™ã•
   - ä¾å­˜æ€§æ³¨å…¥ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–

ã€å‡ºåŠ›å½¢å¼ã€‘
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: [PASS/WARN/FAIL]
ç·åˆç‚¹æ•°: [0-100ç‚¹]

å•é¡Œãƒªã‚¹ãƒˆ:
- ğŸ”´ é‡å¤§ãªå•é¡Œ (ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°): [å…·ä½“çš„ãªèª¬æ˜]
- ğŸŸ¡ æ”¹å–„ææ¡ˆ (éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°): [å…·ä½“çš„ãªèª¬æ˜]
- ğŸŸ¢ å„ªç§€ãªå®Ÿè£…: [ç§°è³›ã™ã¹ãç‚¹]

ä¿®æ­£ææ¡ˆ:
[å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£æ¡ˆ]

ã€åˆ¤å®šãƒ«ãƒ¼ãƒ«ã€‘
- ç‚¹æ•° >= 80: PASS
- ç‚¹æ•° 60-79: WARN (è­¦å‘Šã‚’å‡ºã™ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„)
- ç‚¹æ•° < 60: FAIL (ãƒãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯)

ã‚³ãƒ¼ãƒ‰å¤‰æ›´å†…å®¹:
```

{diff_content}

```
    """
    return prompt
```

**è¨€èªåˆ¥ç‰¹åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**

```python
LANGUAGE_SPECIFIC_RULES = {
    "python": {
        "style": "PEP 8æ¨™æº–",
        "focus": ["å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "ä¾‹å¤–å‡¦ç†", "ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ä½¿ç”¨", "ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å¦¥å½“æ€§"]
    },
    "javascript": {
        "style": "ESLintæ¨™æº–", 
        "focus": ["async/awaitä½¿ç”¨", "ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯", "DOMæ“ä½œã®å®‰å…¨æ€§", "ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã¸ã®å½±éŸ¿"]
    },
    "java": {
        "style": "Google Java Style",
        "focus": ["null ãƒã‚§ãƒƒã‚¯", "ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†", "ä¸¦è¡Œå®‰å…¨æ€§", "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–"]
    },
    "go": {
        "style": "Go fmtæ¨™æº–",
        "focus": ["goroutineãƒªãƒ¼ã‚¯", "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°", "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆ", "ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦"]
    }
}

def get_language_specific_prompt(language, diff_content):
    rules = LANGUAGE_SPECIFIC_RULES.get(language, {})
    
    return f"""
{language}ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã€è¨€èªå›ºæœ‰ã®ãƒã‚§ãƒƒã‚¯é …ç›®ã€‘
- ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: {rules.get('style', 'ä¸€èˆ¬çš„ãªæ¨™æº–')}
- é‡ç‚¹ãƒã‚§ãƒƒã‚¯é …ç›®: {', '.join(rules.get('focus', []))}

ã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã€‘
{diff_content}

ä¸Šè¨˜ã®{language}å›ºæœ‰ã®è¦³ç‚¹ã‹ã‚‰ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
    """
```

## CIå®Ÿè¡Œå›æ•°ã®åˆ¶å¾¡

**æ–¹æ¡ˆ1: ãƒ–ãƒ©ãƒ³ãƒã¨æ¡ä»¶ã«ã‚ˆã‚‹åˆ¶å¾¡**

```yaml
# .gitlab-ci.yml
ai-code-review:
  stage: code-quality
  image: python:3.9
  script:
    - python ai_code_check.py
  rules:
    # MRã®æ™‚ã®ã¿å®Ÿè¡Œ
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # ç‰¹å®šãƒ–ãƒ©ãƒ³ãƒã¸ã®MRã®ã¿
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
    # ãƒ‰ãƒ©ãƒ•ãƒˆMRã‚’é™¤å¤–
    - if: $CI_MERGE_REQUEST_TITLE !~ /^Draft:/
    # å–¶æ¥­æ™‚é–“ã®ã¿å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - if: $CI_PIPELINE_CREATED_AT =~ /T(09|10|11|12|13|14|15|16|17):/
  allow_failure: true  # trueã«ã™ã‚‹ã¨è­¦å‘Šã®ã¿ã§ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
```

**æ–¹æ¡ˆ2: å¤‰æ›´è¦æ¨¡ã«ã‚ˆã‚‹åˆ¶å¾¡**

```python
def should_run_ai_check():
    """AI ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    diff = get_code_diff()
    lines_changed = len([l for l in diff.splitlines() if l.startswith(('+', '-'))])
    
    # å°ã•ãªå¤‰æ›´ã¯AIãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if lines_changed < 10:
        print("ğŸ”„ å¤‰æ›´ãŒå°ã•ã„ãŸã‚ã€AIãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
        return False
    
    # å¤§ãã™ãã‚‹å¤‰æ›´ã¯åˆ†å‰²ã‚’æ¨å¥¨
    if lines_changed > 1000:
        print("ğŸ“¦ å¤‰æ›´ãŒå¤§ãã™ãã¾ã™ã€‚åˆ†å‰²ã—ã¦ã®ã‚³ãƒŸãƒƒãƒˆã‚’æ¨å¥¨ã—ã¾ã™")
        return False
        
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
    changed_files = get_changed_files()
    code_files = [f for f in changed_files if is_code_file(f)]
    
    if not code_files:
        print("ğŸ“„ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒãªã„ãŸã‚ã€AIãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
        return False
        
    return True

def is_code_file(filename):
    """ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    code_extensions = ['.py', '.js', '.java', '.go', '.cpp', '.c', '.php', '.rb']
    return any(filename.endswith(ext) for ext in code_extensions)
```

**æ–¹æ¡ˆ3: ãƒ©ãƒ™ãƒ«ã¨è¨­å®šã«ã‚ˆã‚‹åˆ¶å¾¡**

```yaml
# ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸæ™‚ã®ã¿å®Ÿè¡Œ
ai-code-review:
  script:
    - python ai_code_check.py
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /ai-review/
  
# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã‚‹åˆ¶å¾¡
ai-code-review-optional:
  script:
    - python ai_code_check.py
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[ai-check\]/
```

**æ–¹æ¡ˆ4: æ®µéšçš„ãƒã‚§ãƒƒã‚¯æˆ¦ç•¥**

```python
def get_check_level():
    """ç•°ãªã‚‹æ¡ä»¶ã«åŸºã¥ã„ã¦ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®š"""
    if os.environ.get('CI_MERGE_REQUEST_LABELS', '').find('critical') != -1:
        return 'full'  # å®Œå…¨ãªAIãƒã‚§ãƒƒã‚¯
    elif is_hotfix_branch():
        return 'security'  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®ã¿ãƒã‚§ãƒƒã‚¯
    elif is_feature_branch():
        return 'basic'  # åŸºæœ¬ãƒã‚§ãƒƒã‚¯
    else:
        return 'skip'  # ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—

def is_hotfix_branch():
    """ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    branch_name = os.environ.get('CI_COMMIT_REF_NAME', '')
    return 'hotfix' in branch_name or 'urgent' in branch_name

def is_feature_branch():
    """ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    branch_name = os.environ.get('CI_COMMIT_REF_NAME', '')
    return branch_name.startswith('feature/') or branch_name.startswith('feat/')

# ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®ä½¿ç”¨ä¾‹
check_level = get_check_level()
if check_level == 'skip':
    print("â­ï¸  AIãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
    exit(0)
elif check_level == 'basic':
    prompt = get_basic_prompt(diff)
    print("ğŸ” åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™")
elif check_level == 'security':
    prompt = get_security_prompt(diff)
    print("ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™")
else:
    prompt = get_full_prompt(diff)
    print("ğŸ”¬ å®Œå…¨ãªAIãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™")
```

**æ–¹æ¡ˆ5: ã‚³ã‚¹ãƒˆåˆ¶å¾¡**

```python
import datetime
import os

def check_usage_limit():
    """ä½¿ç”¨é‡åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯"""
    today = datetime.datetime.now().strftime('%Y-%m-%d')
    usage_file = f'/tmp/ai_usage_{today}.txt'
    
    current_count = 0
    if os.path.exists(usage_file):
        with open(usage_file, 'r') as f:
            current_count = int(f.read().strip() or '0')
    
    daily_limit = 50  # 1æ—¥ã®åˆ¶é™å›æ•°
    if current_count >= daily_limit:
        print(f"âš ï¸  æœ¬æ—¥ã®AIãƒã‚§ãƒƒã‚¯å›æ•°ãŒä¸Šé™ï¼ˆ{daily_limit}å›ï¼‰ã«é”ã—ã¾ã—ãŸ")
        return False
    
    # ä½¿ç”¨å›æ•°ã‚’æ›´æ–°
    with open(usage_file, 'w') as f:
        f.write(str(current_count + 1))
    
    print(f"ğŸ“Š æœ¬æ—¥ã®AIãƒã‚§ãƒƒã‚¯ä½¿ç”¨å›æ•°: {current_count + 1}/{daily_limit}")
    return True

def check_monthly_budget():
    """æœˆæ¬¡äºˆç®—ã‚’ãƒã‚§ãƒƒã‚¯"""
    month = datetime.datetime.now().strftime('%Y-%m')
    budget_file = f'/tmp/ai_budget_{month}.txt'
    
    # æ¦‚ç®—ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆä¾‹ï¼š1å›ã®ãƒã‚§ãƒƒã‚¯ã§0.05ãƒ‰ãƒ«ï¼‰
    cost_per_check = 0.05
    monthly_budget = 100.0  # æœˆæ¬¡äºˆç®—100ãƒ‰ãƒ«
    
    if os.path.exists(budget_file):
        with open(budget_file, 'r') as f:
            used_budget = float(f.read().strip() or '0')
    else:
        used_budget = 0
    
    if used_budget + cost_per_check > monthly_budget:
        print(f"ğŸ’° æœˆæ¬¡äºˆç®—ï¼ˆ${monthly_budget}ï¼‰ã‚’è¶…éã—ã¾ã™ã€‚ç¾åœ¨ã®ä½¿ç”¨é¡: ${used_budget:.2f}")
        return False
    
    # äºˆç®—ä½¿ç”¨é‡ã‚’æ›´æ–°
    with open(budget_file, 'w') as f:
        f.write(str(used_budget + cost_per_check))
    
    return True
```

**æ¨å¥¨è¨­å®šã®çµ„ã¿åˆã‚ã›**

```yaml
# å®Ÿç”¨çš„ãªCIè¨­å®š
ai-code-review:
  stage: code-quality
  image: python:3.9
  script:
    - python optimized_ai_check.py
  rules:
    # ä¸»è¦ãƒ–ãƒ©ãƒ³ãƒã¸ã®MRã®ã¿å®Ÿè¡Œ
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && 
          ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || 
           $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop")
    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤‰æ›´ã®ã¿ã®å ´åˆã¯é™¤å¤–
    - changes:
        - "**/*.py"
        - "**/*.js"
        - "**/*.java"
        - "**/*.go"
        - "**/*.php"
        - "**/*.rb"
  allow_failure: true
  timeout: 5m  # é•·æ™‚é–“ã®å¾…æ©Ÿã‚’é¿ã‘ã‚‹
  retry:
    max: 2
    when: runner_system_failure
```

**å®Œå…¨ãªæœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹**

```python
# optimized_ai_check.py
import anthropic
import subprocess
import os
import datetime

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("ğŸš€ æœ€é©åŒ–ã•ã‚ŒãŸAIã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...")
    
    # ä½¿ç”¨é‡åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if not check_usage_limit():
        exit(0)
    
    # ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    if not should_run_ai_check():
        exit(0)
    
    # ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®š
    check_level = get_check_level()
    if check_level == 'skip':
        print("â­ï¸  è¨­å®šã«ã‚ˆã‚ŠAIãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
        exit(0)
    
    # ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’å–å¾—
    diff = get_code_diff()
    file_types = get_changed_file_types()
    commit_message = os.environ.get('CI_COMMIT_MESSAGE', '')
    
    # ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
    if check_level == 'basic':
        prompt = get_basic_prompt(diff, file_types, commit_message)
    elif check_level == 'security':
        prompt = get_security_prompt(diff, file_types, commit_message)
    else:
        prompt = get_optimized_prompt(diff, file_types, commit_message)
    
    # AIãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    result = check_code_quality(prompt)
    
    if not result:
        print("ğŸ’¥ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚CIã‚’å¤±æ•—ã•ã›ã¾ã™ã€‚")
        exit(1)
    
    print("ğŸ‰ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚")

if __name__ == "__main__":
    main()
```

ã“ã®ã‚ˆã†ã«ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–ã¨CIå®Ÿè¡Œåˆ¶å¾¡ã®ä¸¡æ–¹ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ã§å®Ÿç”¨çš„ãªAIã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

ä½•ã‹ã”è³ªå•ã‚„è¿½åŠ ã®æ©Ÿèƒ½ãŒå¿…è¦ã§ã—ãŸã‚‰ã€ãŠèã‹ã›ãã ã•ã„ï¼â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
